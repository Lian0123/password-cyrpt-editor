<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="WebMCP 調用範例頁，支援 tools/list 與 tools/call 測試，包含 postMessage 與 HTTP 模式。" />
  <meta name="robots" content="index,follow" />
  <title>WebMCP 調用範例頁</title>
  <style>
    :root {
      --bg: #f4f6fb;
      --panel: #ffffff;
      --line: #d9e0ef;
      --text: #172033;
      --muted: #5d6a86;
      --primary: #315efb;
      --ok: #0f9d58;
      --warn: #c26400;
      --danger: #cc2f45;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      line-height: 1.5;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
    }
    h1, h2, h3 { margin: 0 0 8px; }
    .sub { color: var(--muted); font-size: 13px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 4px 10px;
      font-size: 12px;
      color: var(--muted);
      background: #f8faff;
    }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .danger { color: var(--danger); }
    input, select, textarea {
      width: 100%;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
      min-height: 36px;
    }
    textarea {
      min-height: 150px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.45;
    }
    .btn {
      appearance: none;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f4f7ff;
      color: var(--text);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      min-height: 34px;
    }
    .btn.primary { background: var(--primary); color: #fff; border-color: #315efb; }
    .btn.ghost { background: #fff; }
    .btn.warn { background: #fff3e3; }
    .two { display: grid; grid-template-columns: 220px 1fr; gap: 10px; align-items: start; }
    code.inline {
      background: #eef3ff;
      border: 1px solid #d7e1ff;
      border-radius: 6px;
      padding: 1px 6px;
      font-size: 12px;
    }
    .output {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f9fbff;
      padding: 10px;
      min-height: 140px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    .footer { text-align: center; font-size: 12px; color: var(--muted); }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .two { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1 id="title">WebMCP 調用範例頁</h1>
      <div class="sub" id="intro">用途：測試 tools/list、tools/call，並驗證 postMessage / HTTP 兩種傳輸。請先開啟主頁。</div>
      <div class="row" style="margin-top:8px;">
        <span class="badge">主頁 URL（同網域） <code class="inline">./index.html</code></span>
        <span class="badge" id="status">連線狀態：尚未連線</span>
      </div>
    </section>

    <section class="card two">
      <div>
        <h3 id="transportTitle">Transport模式</h3>
        <select id="transport">
          <option value="postMessage">postMessage</option>
          <option value="http">HTTP</option>
        </select>
        <div class="sub" id="transportDesc" style="margin-top:6px;">目前 WebMCP 已移除 auth 驗證，可直接呼叫。</div>
      </div>
      <div class="row">
        <button class="btn primary" id="btnConnect">開啟主頁並建立連線</button>
        <button class="btn" id="btnToolsList">tools/list</button>
        <button class="btn" id="btnCardState">card.getState</button>
        <button class="btn warn" id="btnLangFr">切換語言 → fr-FR</button>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h2 id="rpcTitle">工具呼叫範例</h2>
        <div class="row" style="margin-bottom:8px;">
          <button class="btn ghost" id="loadTemplate">載入範例</button>
          <button class="btn ghost" id="copyTemplate">複製 RPC</button>
        </div>
        <label class="sub" id="argsTitle">arguments (JSON)</label>
        <textarea id="rpcEditor">{
  "jsonrpc": "2.0",
  "id": "demo-1",
  "method": "tools/call",
  "params": {
    "name": "card.getState",
    "arguments": {}
  }
}</textarea>
        <div class="row" style="margin-top:8px;">
          <button class="btn primary" id="btnCall">送出 RPC</button>
        </div>
      </div>

      <div class="card">
        <h2 id="responseTitle">tools/call Response</h2>
        <div class="output" id="output">(尚無輸出)</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 id="langTitle">語言</h3>
          <div class="sub" id="langDesc">多語介面示範（繁中 / English / 日本語）</div>
        </div>
        <select id="lang" style="max-width:220px;">
          <option value="zh">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
        </select>
      </div>
    </section>

    <div class="footer">WebMCP Example · Crypto Flow Studio</div>
  </div>

  <script>
    const i18n = {
      zh: {
        title: "WebMCP 調用範例頁",
        intro: "用途：測試 tools/list、tools/call，並驗證 postMessage / HTTP 兩種傳輸。請先開啟主頁。",
        disconnected: "連線狀態：尚未連線",
        connected: "連線狀態：已連線",
        transportTitle: "Transport模式",
        transportDesc: "目前 WebMCP 已移除 auth 驗證，可直接呼叫。",
        connect: "開啟主頁並建立連線",
        toolsList: "tools/list",
        cardState: "card.getState",
        switchFr: "切換語言 → fr-FR",
        rpcTitle: "工具呼叫範例",
        loadTemplate: "載入範例",
        copyTemplate: "複製 RPC",
        argsTitle: "arguments (JSON)",
        sendRpc: "送出 RPC",
        responseTitle: "tools/call Response",
        langTitle: "語言",
        langDesc: "多語介面示範（繁中 / English / 日本語）"
      },
      en: {
        title: "WebMCP Call Example",
        intro: "Use this page to test tools/list and tools/call via postMessage or HTTP transport.",
        disconnected: "Connection: disconnected",
        connected: "Connection: connected",
        transportTitle: "Transport Mode",
        transportDesc: "Auth is removed in current WebMCP, direct calls are allowed.",
        connect: "Open index and connect",
        toolsList: "tools/list",
        cardState: "card.getState",
        switchFr: "Switch language → fr-FR",
        rpcTitle: "Tool Call Example",
        loadTemplate: "Load template",
        copyTemplate: "Copy RPC",
        argsTitle: "arguments (JSON)",
        sendRpc: "Send RPC",
        responseTitle: "tools/call Response",
        langTitle: "Language",
        langDesc: "Multilingual UI demo (zh / en / ja)"
      },
      ja: {
        title: "WebMCP 呼び出しサンプル",
        intro: "tools/list と tools/call を postMessage / HTTP で検証します。先に主ページを開いてください。",
        disconnected: "接続状態：未接続",
        connected: "接続状態：接続済み",
        transportTitle: "Transportモード",
        transportDesc: "現在の WebMCP は auth 不要で直接呼び出せます。",
        connect: "主ページを開いて接続",
        toolsList: "tools/list",
        cardState: "card.getState",
        switchFr: "言語切替 → fr-FR",
        rpcTitle: "ツール呼び出し例",
        loadTemplate: "テンプレート読込",
        copyTemplate: "RPCをコピー",
        argsTitle: "arguments (JSON)",
        sendRpc: "RPC送信",
        responseTitle: "tools/call Response",
        langTitle: "言語",
        langDesc: "多言語UIデモ（繁中 / 英語 / 日本語）"
      }
    };

    let peerWindow = null;
    let connected = false;

    const elements = {
      title: document.getElementById("title"),
      intro: document.getElementById("intro"),
      status: document.getElementById("status"),
      transportTitle: document.getElementById("transportTitle"),
      transportDesc: document.getElementById("transportDesc"),
      btnConnect: document.getElementById("btnConnect"),
      btnToolsList: document.getElementById("btnToolsList"),
      btnCardState: document.getElementById("btnCardState"),
      btnLangFr: document.getElementById("btnLangFr"),
      rpcTitle: document.getElementById("rpcTitle"),
      loadTemplate: document.getElementById("loadTemplate"),
      copyTemplate: document.getElementById("copyTemplate"),
      argsTitle: document.getElementById("argsTitle"),
      btnCall: document.getElementById("btnCall"),
      responseTitle: document.getElementById("responseTitle"),
      langTitle: document.getElementById("langTitle"),
      langDesc: document.getElementById("langDesc"),
      output: document.getElementById("output"),
      rpcEditor: document.getElementById("rpcEditor"),
      transport: document.getElementById("transport"),
      lang: document.getElementById("lang")
    };

    function setOutput(obj) {
      elements.output.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    function setLang(lang) {
      const t = i18n[lang] || i18n.zh;
      elements.title.textContent = t.title;
      elements.intro.textContent = t.intro;
      elements.transportTitle.textContent = t.transportTitle;
      elements.transportDesc.textContent = t.transportDesc;
      elements.btnConnect.textContent = t.connect;
      elements.btnToolsList.textContent = t.toolsList;
      elements.btnCardState.textContent = t.cardState;
      elements.btnLangFr.textContent = t.switchFr;
      elements.rpcTitle.textContent = t.rpcTitle;
      elements.loadTemplate.textContent = t.loadTemplate;
      elements.copyTemplate.textContent = t.copyTemplate;
      elements.argsTitle.textContent = t.argsTitle;
      elements.btnCall.textContent = t.sendRpc;
      elements.responseTitle.textContent = t.responseTitle;
      elements.langTitle.textContent = t.langTitle;
      elements.langDesc.textContent = t.langDesc;
      elements.status.textContent = connected ? t.connected : t.disconnected;
    }

    function postMessageRpc(payload) {
      if (!peerWindow || peerWindow.closed) throw new Error("主頁尚未連線");
      peerWindow.postMessage({ type: "WEBMCP_RPC", payload }, "*");
      return { sent: true, transport: "postMessage", payload };
    }

    async function httpRpc(payload) {
      return {
        sent: false,
        transport: "http",
        note: "此為示例頁，請接到你後端 /webmcp endpoint",
        payload
      };
    }

    function getTemplate(method = "tools/call", tool = "card.getState", args = {}) {
      return {
        jsonrpc: "2.0",
        id: `demo-${Date.now()}`,
        method,
        params: method === "tools/list" ? {} : { name: tool, arguments: args }
      };
    }

    document.getElementById("btnConnect").onclick = () => {
      peerWindow = window.open("./index.html", "crypto-flow-main");
      connected = !!peerWindow;
      setLang(elements.lang.value);
      setOutput({ ok: connected, message: connected ? "主頁已開啟，請允許彈窗" : "開啟失敗" });
    };

    document.getElementById("btnToolsList").onclick = async () => {
      const payload = getTemplate("tools/list");
      const result = elements.transport.value === "postMessage" ? postMessageRpc(payload) : await httpRpc(payload);
      setOutput(result);
    };

    document.getElementById("btnCardState").onclick = async () => {
      const payload = getTemplate("tools/call", "card.getState", {});
      const result = elements.transport.value === "postMessage" ? postMessageRpc(payload) : await httpRpc(payload);
      setOutput({
        ...result,
        expected: "回傳 cardType、lang、theme、cardData、貼圖與 WebMCP 狀態資訊。"
      });
    };

    document.getElementById("btnLangFr").onclick = async () => {
      const payload = getTemplate("tools/call", "card.setLanguage", { lang: "fr-FR" });
      const result = elements.transport.value === "postMessage" ? postMessageRpc(payload) : await httpRpc(payload);
      setOutput(result);
    };

    document.getElementById("loadTemplate").onclick = () => {
      elements.rpcEditor.value = JSON.stringify(getTemplate("tools/call", "card.getState", {}), null, 2);
    };

    document.getElementById("copyTemplate").onclick = async () => {
      await navigator.clipboard.writeText(elements.rpcEditor.value);
      setOutput("已複製 RPC 模板");
    };

    document.getElementById("btnCall").onclick = async () => {
      try {
        const payload = JSON.parse(elements.rpcEditor.value);
        const result = elements.transport.value === "postMessage" ? postMessageRpc(payload) : await httpRpc(payload);
        setOutput(result);
      } catch (e) {
        setOutput({ error: e.message });
      }
    };

    window.addEventListener("message", (event) => {
      if (event?.data?.type === "WEBMCP_RPC_RESULT") {
        setOutput(event.data.payload);
      }
    });

    elements.lang.onchange = (e) => setLang(e.target.value);
    setLang("zh");
  </script>
</body>
</html>
